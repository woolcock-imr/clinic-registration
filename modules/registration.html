<div id=toolbar__ID>
    <a id=back__ID>Back</a>
</div>
<section class="w3s">
    <form id=F__ID class="w3-padding-0 w3-margin-0 ">
        <div class="w3-container w3-content w3-row " style="max-width:600px;background-image:url('__BASE__/woolcock-imr/woolcock_images/empty.gif');background-repeat: no-repeat; " >
            <div class="w3-center w3-padding">
                <h2 class="w3-xxlarge">Woolcock Clinics Registration</h2>
            </div>
            <div class="w3-container">
                <div class="w3-half">
                    <span class="w3-padding">First Name</span>
                    <div class="w3-center w3-padding">
                        <input type="text" class="w3-input w3-border" id="First_Name__ID" name="First_Name__ID" placeholder="First Name">
                    </div>
                </div>
                <div class="w3-half ">
                    <span class="w3-padding">Last Name</span>
                    <div class="w3-center w3-padding">
                        <input type="text" class="w3-input w3-border" id="Last_Name__ID" name="Last_Name__ID"  placeholder="Last Name">
                    </div>
                </div>
            </div>
            <div class="w3-container">
                <div class="w3-half">
                    <span class="w3-padding">Date of birth</span>
                    <div class="w3-center w3-padding">
                        <input type="text" class="w3-input w3-border" id="DOB__ID" name="DOB__ID" placeholder="Date of birth">
                    </div>
                </div>
                <div class="w3-half">
                    <span class="w3-padding">Gender</span>
                    <div class="w3-center w3-padding">
                        <select class="w3-input" id=Gender__ID Name=Gender__ID placeholder="Gender">
                            <option >...</option>
                            <option >Male</option>
                            <option >Female</option>
                            <option >Indeterminate/Intersex/Unspecified</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="w3-padding">
                <span class="w3-padding">Address</span>
                <div class="w3-center w3-padding">
                    <textarea class="w3-input w3-border" id=Address__ID name="Address__ID" placeholder="Address"></textarea>
                </div>
            </div>
            <div class="w3-container">
                <div class="w3-half">
                    <span class="w3-padding">Suburb/Town</span>
                    <div class="w3-center w3-padding">
                        <input type="text" class="w3-input w3-border" id=Suburb__ID name="Suburb__ID"  placeholder="Suburb/Town">
                    </div>
                </div>
                <div class="w3-half">
                    <span class="w3-padding">Postcode</span>
                    <div class="w3-center w3-padding">
                        <input type="text" class="w3-input w3-border" id=Postcode__ID name="Postcode__ID" placeholder="Postcode">
                    </div>
                </div>
            </div>
            <div class="w3-container">
                <div class="w3-half">
                    <span class="w3-padding">Phone</span>
                    <div class="w3-center w3-padding">
                        <input type="text" class="w3-input w3-border" id=Phone__ID name="Phone__ID" placeholder="Phone">
                    </div>
                </div>
                <div class="w3-half">
                    <span class="w3-padding">Email</span>
                    <div class="w3-center w3-padding">
                        <input type="text" class="w3-input w3-border" id=Email__ID name="Email__ID" placeholder="Email">
                    </div>
                </div>
            </div>
            <div class="w3-padding">
                <span class="w3-padding">Emergency contact</span>
                <div class="w3-center w3-padding">
                    <input type="text" class="w3-input w3-border" id="Emergency_contact__ID" name="Emergency_contact__ID"  placeholder="Emergency contact">
                </div>
            </div>
            <div class="w3-padding">
                <span class="w3-padding">Emergency contact number</span>
                <div class="w3-center w3-padding">
                    <input type="text" class="w3-input w3-border" id="Emergency_contact_number__ID" name="Emergency_contact_number__ID" placeholder="Emergency contact number">
                </div>
            </div>
            <div class="w3-center w3-padding">
                <input class="w3-button w3-blue w3-round-large" type=btn id=submit__ID value="Submit" />
            </div>
            <div class="w3-center w3-padding">
                <img class="" src="__BASE__/woolcock-imr/woolcock_images/logo.jpg" style='width:500px'></img>
            </div>

        </div>
    </form>
</section>
<script>
    function F__ID(){
        //-------------------------------------
		VmInclude:__PARTS__/toolbar/back.js
        VmInclude:__PARTS__/style/ease-in-out.2.js
        //-------------------------------------
		var _mlist=$vm.module_list;
		var _mobj=$vm.vm['__ID'];
		var _sys='';
		var _config='';
		var _ids='';
		if(_mobj.op!=undefined && _mobj.op.sys!=undefined){
			_sys=_mobj.op.sys;
			if(_sys.config!=undefined){
				_config=_sys.config;
				if(_config.module_ids!=undefined){
					_ids=_config.module_ids;
				}
			}
		}
		//-----------------------------------------------
		var _db_pid=_mlist[_ids['registration']].table_id
		var questionnaire_participant_pid='20011177';
		var questionnaire_participant_setup_pid='20011178';
		//-----------------------------------------------
		$('#D__ID').on('load',function(){
            $('#F__ID')[0].reset();
        })
        //-------------------------------------
		var Exclude=0;
        $('#submit__ID').on('click',function(){
			//-------------------------------------
			//validation
			if($('#First_Name__ID').val()===''){    $vm.alert("First name is compulsory");    return;            }
            if($('#Last_Name__ID').val()===''){     $vm.alert("Last name is compulsory");     return;            }
			if($('#Email__ID').val()===''){         $vm.alert("Email is compulsory");         return;            }
			var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            if(re.test($('#Email__ID').val())===false){
                $vm.alert("Invalid email format");
                return;
            }
			//-------------------------------------
            var record={}
			record.First_Name=$('#First_Name__ID').val();
            record.Last_Name=$('#Last_Name__ID').val();
            record.Gender=$('#Gender__ID').val();
            record.DOB=$('#DOB__ID').val();
            record.Address=$('#Address__ID').val();
            record.Suburb=$('#Suburb__ID').val();
            record.Postcode=$('#Postcode__ID').val();
            record.Phone=$('#Phone__ID').val();
            record.Email=$('#Email__ID').val();
            record.Emergency_contact=$('#Emergency_contact__ID').val();
            record.Emergency_contact_number=$('#Emergency_contact_number__ID').val();

			var dbv={};
            dbv.S1=$('#Email__ID').val();
            dbv.S2=$('#Email__ID').val();
            var req={cmd:"s1_s2_unique_add_record",db_pid:_db_pid,data:record,dbv:dbv};
            $VmAPI.request({data:req,callback:function(res){
				if(res.ret=='-1'){
					$vm.alert('The email already exists');
					return;
				}
				//create participant, setup record, send email and redirect to thanks page
				create_questionnaire_participant_record(res);
            }});
		})
		//-------------------------------------
		var create_questionnaire_participant_record=function(res){
            var registration_id=res.uid;
            var record={Registration_ID:registration_id};
            var dbv={S1:registration_id,S2:registration_id};
			var req={cmd:"s1_s2_unique_add_record",db_pid:questionnaire_participant_pid,data:record,dbv:dbv};
            $VmAPI.request({data:req,callback:function(res2){
				if(res2.ret=='-1'){
					$vm.alert('The email already exists');
					return;
				}
                create_questionnaire_participant_setup_record(res2);
            }})
        }
        //-------------------------------------
        var create_questionnaire_participant_setup_record=function(res2){
			var participant_uid=res2.uid
            var username=participant_uid+"-"+questionnaire_participant_setup_pid;
            var password=$vm.vm_password(8,false);
			var List="20011175,20011176";
            var record={Login_ID:username,Password:password,List:List};
            var dbv={PUID:participant_uid,S1:username,S2:username,S3:password};
            var req={cmd:"s1_s2_unique_add_record",db_pid:questionnaire_participant_setup_pid,data:record,dbv:dbv};
            $VmAPI.request({data:req,callback:function(res3){
				if(res3.ret=='-1'){
					$vm.alert('The setup record already exists');
					return;
				}
                send_email(username,password);
            }})
        }
        //-------------------------------------
        var send_email=function(username,password){
            var From_Address="woolcock.reception@woolcock.org.au";
            var From_Name="Woolcock Institute of Medical Research";
            var To=$('#Email__ID').val();
            var Title="Wooolcock Clinics Registration";
            var Body="Thank you for registering. Please complete our online questionnaire. Simply click on the website link below and enter the provided Username and Password:<br />"
    		Body+="&nbsp;<br />"
    		Body+="&nbsp;<br />";
            Body+="Website: https://wool"+"cock-imr.github.io/online-questionnaire/index.html<br>";
    		Body+="Username: "+username+"<br>";
    		Body+="Password: "+password+"<br>";
    		Body+="&nbsp;<br />"
    		Body+=" If you are be unable to complete the questionnaire today, your answers will be saved and you can use the login details above to continue the questionnaire"
        	Body+="<br>If you have any questions about completing our questionnaire, please email woolcock.reception@woolcock.org.au"
    		Body+="&nbsp;<br />"
    		Body+="&nbsp;<br />"
    		$VmAPI.request({data:{cmd:'send_email',From_Address:From_Address,From_Name:From_Name,To:To,Title:Title,Body:Body},callback:function(res){
				var module_id=_ids["thanks"];
				$vm.load_module_by_name(module_id,$vm.root_layout_content_slot,{
					mobj:_mobj,
					sys:_sys,
				})
            }})
        }
		//-------------------------------------
    }
</script>
<style>
	VmInclude:__PARTS__/toolbar/toolbar.css
    VmInclude:__HOST__/css/w3.css
    .rowthree,.rowtwo,.rowone{
        display: inline-block;
    }
</style>
